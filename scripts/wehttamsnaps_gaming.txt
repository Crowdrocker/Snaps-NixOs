{ config, pkgs, inputs, ... }:

{
  # === GAMING OPTIMIZATIONS FOR AMD RX 580 ===
  
  # Enable GameMode
  programs.gamemode = {
    enable = true;
    enableRenice = true;
    settings = {
      general = {
        renice = 10;
        ioprio = 0;
        inhibit_screensaver = 1;
      };
      
      gpu = {
        apply_gpu_optimisations = "accept-responsibility";
        gpu_device = 0;
        amd_performance_level = "high";
      };
      
      custom = {
        start = "${pkgs.libnotify}/bin/notify-send 'GameMode' 'Performance optimizations active'";
        end = "${pkgs.libnotify}/bin/notify-send 'GameMode' 'Back to normal mode'";
      };
    };
  };
  
  # Steam with optimizations
  programs.steam = {
    enable = true;
    remotePlay.openFirewall = true;
    dedicatedServer.openFirewall = true;
    gamescopeSession.enable = true;
    
    # Steam launch options will be applied per-game
    extraCompatPackages = with pkgs; [
      proton-ge-bin
    ];
  };
  
  # Gaming packages from Chaotic-CX
  environment.systemPackages = with pkgs; [
    # === GAME LAUNCHERS ===
    steam
    lutris
    heroic
    bottles
    
    # === WINE & COMPATIBILITY ===
    wine
    winetricks
    protontricks
    
    # === PERFORMANCE TOOLS ===
    gamescope
    mangohud
    goverlay # MangoHud configurator
    gamemode
    
    # === VULKAN ===
    vulkan-tools
    vulkan-loader
    vulkan-validation-layers
    vulkan-extension-layer
    
    # === DXVK (DirectX to Vulkan) ===
    dxvk
    vkd3d
    
    # === MODDING TOOLS ===
    # steamtinkerlaunch - for Vortex/MO2
    steamtinkerlaunch
    
    # === CONTROLLER SUPPORT ===
    linuxConsoleTools
    xboxdrv
    
    # === STREAMING ===
    obs-studio
    obs-studio-plugins.obs-pipewire-audio-capture
    obs-studio-plugins.wlrobs
    
    # === MONITORING ===
    nvtop # GPU monitoring
    corectrl # AMD GPU control
  ];
  
  # === STEAM LAUNCH OPTIONS HELPER ===
  environment.etc."steam-launch-options.txt".text = ''
    # WehttamSnaps Steam Launch Options Reference
    # Copy-paste these into your games' launch options in Steam
    
    # === GENERAL GAMING (Use for most games) ===
    gamemoderun mangohud %command%
    
    # === PROTON GE (Better compatibility) ===
    PROTON_USE_WINED3D=1 gamemoderun %command%
    
    # === FSYNC (Better performance) ===
    PROTON_NO_ESYNC=1 PROTON_USE_FSYNC=1 gamemoderun mangohud %command%
    
    # === AMD GPU OPTIMIZATIONS ===
    RADV_PERFTEST=gpl,nggc AMD_VULKAN_ICD=RADV gamemoderun mangohud %command%
    
    # === YOUR GAMES ===
    
    ## Cyberpunk 2077
    gamemoderun mangohud DXVK_ASYNC=1 RADV_PERFTEST=gpl %command%
    
    ## Fallout 4 (with modding support via steamtinkerlaunch)
    steamtinkerlaunch %command%
    
    ## The Division 1 & 2
    PROTON_USE_WINED3D=0 gamemoderun mangohud %command%
    
    ## Call of Duty HQ
    gamemoderun DXVK_ASYNC=1 %command%
    
    ## Shadow of the Tomb Raider
    gamemoderun mangohud RADV_PERFTEST=gpl %command%
    
    ## The First Descendant
    gamemoderun mangohud PROTON_USE_EAC_LAUNCHER=1 %command%
    
    ## Warframe
    gamemoderun %command%
    
    ## Watch Dogs Series
    PROTON_USE_WINED3D=0 gamemoderun mangohud %command%
    
    ## Ghost Recon Breakpoint
    gamemoderun mangohud DXVK_ASYNC=1 %command%
    
    ## Need for Speed Payback
    PROTON_NO_ESYNC=1 gamemoderun %command%
    
    ## Marvel's Avengers
    gamemoderun mangohud RADV_PERFTEST=gpl,nggc %command%
    
    ## FarCry 5
    gamemoderun mangohud %command%
    
    ## Rise of the Tomb Raider
    gamemoderun mangohud RADV_PERFTEST=gpl %command%
    
    # === MANGOHUD CONFIG ===
    # Create ~/.config/MangoHud/MangoHud.conf with:
    # fps_limit=60
    # vsync=1
    # gl_vsync=1
  '';
  
  # === CORECTL FOR AMD GPU CONTROL ===
  programs.corectrl = {
    enable = true;
    gpuOverclock.enable = true;
  };
  
  # === UDEV RULES FOR CONTROLLERS ===
  services.udev.extraRules = ''
    # Steam Controller
    SUBSYSTEM=="usb", ATTRS{idVendor}=="28de", MODE="0666"
    KERNEL=="hidraw*", ATTRS{idVendor}=="28de", MODE="0666"
    KERNEL=="hidraw*", KERNELS=="*28DE:*", MODE="0666"
    
    # Xbox Controllers
    SUBSYSTEM=="usb", ATTRS{idVendor}=="045e", MODE="0666"
    
    # PlayStation Controllers
    SUBSYSTEM=="usb", ATTRS{idVendor}=="054c", MODE="0666"
  '';
  
  # === KERNEL PARAMETERS FOR GAMING ===
  boot.kernelParams = [
    # AMD GPU optimizations
    "amd_pstate=active"
    "amdgpu.ppfeaturemask=0xffffffff"
    
    # Memory management for gaming
    "vm.max_map_count=2147483642"
    
    # Reduce swap usage (good with 16GB RAM + ZRAM)
    "vm.swappiness=10"
  ];
  
  # === SYSCTL OPTIMIZATIONS ===
  boot.kernel.sysctl = {
    # Network optimizations for online gaming
    "net.core.netdev_max_backlog" = 16384;
    "net.core.somaxconn" = 8192;
    "net.core.rmem_default" = 1048576;
    "net.core.rmem_max" = 16777216;
    "net.core.wmem_default" = 1048576;
    "net.core.wmem_max" = 16777216;
    "net.ipv4.tcp_rmem" = "4096 1048576 2097152";
    "net.ipv4.tcp_wmem" = "4096 65536 16777216";
    "net.ipv4.tcp_congestion_control" = "bbr";
    
    # File system optimizations
    "vm.dirty_ratio" = 10;
    "vm.dirty_background_ratio" = 5;
  };
  
  # === GAMING DRIVE AUTO-MOUNT ===
  fileSystems."/run/media/wehttamsnaps/LINUXDRIVE-1" = {
    device = "/dev/disk/by-label/LINUXDRIVE-1";  # Adjust if needed
    fsType = "ext4";
    options = [ "defaults" "nofail" "x-gvfs-show" ];
  };
  
  # === MANGOHUD DEFAULT CONFIG ===
  environment.etc."MangoHud/MangoHud.conf".text = ''
    # WehttamSnaps MangoHud Configuration
    
    # Display settings
    position=top-right
    font_size=20
    
    # What to show
    fps
    frametime
    cpu_temp
    gpu_temp
    ram
    vram
    
    # Colors (WehttamSnaps theme)
    text_color=00FFFF
    gpu_color=8A2BE2
    cpu_color=8A2BE2
    engine_color=FF69B4
    
    # FPS limit (disable in-game, use this instead)
    fps_limit=0
    vsync=0
    
    # Logging
    output_folder=/home/wehttamsnaps/Documents/mangohud-logs
    log_duration=30
    autostart_log=0
  '';
}
